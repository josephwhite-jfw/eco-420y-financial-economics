---
title: "TWFE Sensitivity Models — Raw Summaries"
author: "Joe White"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  pdf_document:
    latex_engine: xelatex
    toc: false
    number_sections: false
fontsize: 11pt
geometry: margin=1in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(scipen = 999, digits = 3, fixest_nthreads = 4)

suppressPackageStartupMessages({
  library(fixest)
  library(dplyr)
  library(readr)
})
```

```{r sensitivity-raw-summaries, results='asis'}
# ===== Load Data =====
panel_fp <- "C:/Repositories/white-bowblis-nhmc/data/clean/panel.csv"

need <- c(
  "cms_certification_number","year_month",
  "anticipation1","anticipation2","post",
  "rn_hppd","lpn_hppd","cna_hppd","total_hppd",
  "government","non_profit","chain","beds",
  "occupancy_rate","pct_medicare","pct_medicaid",
  "cm_q_state_2","cm_q_state_3","cm_q_state_4"
)

df <- read_csv(panel_fp, show_col_types = FALSE, col_select = all_of(need)) %>%
  mutate(
    cms_certification_number = as.factor(cms_certification_number),
    year_month = as.factor(year_month),
    ym_date = as.Date(paste0(gsub("/", "-", as.character(year_month)), "-01"))
  )

# ===== Log outcomes =====
mk_log <- function(x) ifelse(x > 0, log(x), NA_real_)
df <- df %>%
  mutate(
    ln_rn    = mk_log(rn_hppd),
    ln_lpn   = mk_log(lpn_hppd),
    ln_cna   = mk_log(cna_hppd),
    ln_total = mk_log(total_hppd)
  )

# ===== Regression spec =====
controls <- paste(
  "government + non_profit + chain + beds +",
  "occupancy_rate + pct_medicare + pct_medicaid +",
  "cm_q_state_2 + cm_q_state_3 + cm_q_state_4"
)
rhs <- paste("post +", controls, "| cms_certification_number + year_month")
make_fml <- function(lhs) as.formula(paste(lhs, "~", rhs))
vc <- ~ cms_certification_number + year_month

# ===== Scenario setup =====
baseline_chain <- df %>%
  filter(ym_date >= as.Date("2017-01-01"), ym_date <= as.Date("2017-03-31")) %>%
  arrange(cms_certification_number, ym_date) %>%
  group_by(cms_certification_number) %>%
  summarise(baseline_chain_2017Q1 = first(chain), .groups = "drop")

df_bc <- df %>% left_join(baseline_chain, by = "cms_certification_number")

SCENARIOS <- list(
  "Pre-pandemic (2017–2019)" = df %>% filter(ym_date >= as.Date("2017-01-01"), ym_date <= as.Date("2019-12-31")),
  "Pandemic (2020Q2–2024Q2)" = df %>% filter(ym_date >= as.Date("2020-04-01"), ym_date <= as.Date("2024-06-30")),
  "For-profit only"          = df %>% filter(government == 0, non_profit == 0),
  "Chain in 2017Q1"          = df_bc %>% filter(!is.na(baseline_chain_2017Q1), baseline_chain_2017Q1 == 1),
  "Non-chain in 2017Q1"      = df_bc %>% filter(!is.na(baseline_chain_2017Q1), baseline_chain_2017Q1 == 0)
)

SAMPLES <- list(
  "With anticipation (full sample)" = function(d) d,
  "Without anticipation I (anticipation1==0)"  = function(d) d %>% filter(anticipation1 == 0),
  "Without anticipation II (anticipation2==0)" = function(d) d %>% filter(anticipation2 == 0)
)

OUTS <- list(
  "RN (level)"    = "rn_hppd",
  "LPN (level)"   = "lpn_hppd",
  "CNA (level)"   = "cna_hppd",
  "Total (level)" = "total_hppd",
  "Log RN"        = "ln_rn",
  "Log LPN"       = "ln_lpn",
  "Log CNA"       = "ln_cna",
  "Log Total"     = "ln_total"
)

# ===== Run Models =====
for (sc in names(SCENARIOS)) {
  cat(paste0("## Scenario: ", sc, "

"))
  d_sc <- SCENARIOS[[sc]]

  for (sn in names(SAMPLES)) {
    cat(paste0("### Sample: ", sn, "

"))
    d_s <- SAMPLES[[sn]](d_sc)
    if (!nrow(d_s)) {
      cat("No data available in this sample.

")
      next
    }

    for (on in names(OUTS)) {
      lhs <- OUTS[[on]]
      if (all(is.na(d_s[[lhs]]))) next

      cat(paste0("#### Outcome: ", on, "

"))
      fml <- make_fml(lhs)
      m <- feols(fml, data = d_s, vcov = vc, lean = TRUE)

      # Capture and print inside a code block to protect LaTeX from underscores, %, etc.
      out <- capture.output(summary(m))
      cat("```
", paste(out, collapse = "
"), "
```

", sep = "")
    }
  }
}
```
